name: YouTube Auto Archive

on:
  # 毎時0分に実行
  schedule:
    - cron: '0 * * * *'

  # 手動トリガー
  workflow_dispatch:
    inputs:
      hours:
        description: '過去何時間のイベントを対象にするか'
        required: false
        default: '1'
      dry_run:
        description: 'ドライラン（実行せずに確認のみ）'
        required: false
        type: boolean
        default: false

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install yt-dlp
        run: |
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp
          yt-dlp --version

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Run auto archive
        env:
          LARK_APP_ID: ${{ secrets.LARK_APP_ID }}
          LARK_APP_SECRET: ${{ secrets.LARK_APP_SECRET }}
          LARKBASE_APP_TOKEN: ${{ secrets.LARKBASE_APP_TOKEN }}
          LARKBASE_TABLE_ID: ${{ secrets.LARKBASE_TABLE_ID }}
          LARK_DRIVE_FOLDER_ID: ${{ secrets.LARK_DRIVE_FOLDER_ID }}
        run: |
          HOURS="${{ github.event.inputs.hours || '1' }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [ "$DRY_RUN" = "true" ]; then
            npx ts-node scripts/auto-archive-ended-events.ts --hours "$HOURS" --dry-run
          else
            npx ts-node scripts/auto-archive-ended-events.ts --hours "$HOURS"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Auto archive failed. Check the logs for details."
